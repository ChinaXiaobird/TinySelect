/**
 * TinySelect 0.4.4 2018-05-31
 * @作者: hyjiacan
 * @源码: https://gitee.com/hyjiacan/TinySelect.git
 * @示例: http://hyjiacan.oschina.io/tinyselect
 * @许可协议: MIT
 * @依赖: jQuery 1.8.0及更高版本
 * @浏览器支持: 不支持IE8及更低版本
 * @QQ群: 187786345 (Javascript爱好者)
 */

!function(a,b){"use strict";function c(a){this.selector=[],this.css(a)}function d(a,c,e){var f=b(a).get(0);if(f){for(var g,h=0;h<ca.length;h++)if(g=ca[h],g.source.get(0)===f)return g;return g=new d.fn.init(f,c,e),ca.push(g),g}}function e(a,c){var d=b("<div>"),e=a.option,f=e.result,g=c.get(0);if(Object.defineProperty(a,"fromSelect",{writabke:ia,configurable:ia,value:ha}),!f||!f.style&&!f.css){var h=c.height();b.each(["padding","margin","box-sizing","color","background","background-color","font","border","lineHeight","top","right","bottom","left"],function(a,b){d.css(b,c.css(b))});var i=X(c,"position"),j=Y(c);d.css({position:/^static$/.test(i)?"relative":i,width:c.width(),height:h,lineHeight:h-j.top-j.bottom+"px"})}f.multi=g.hasAttribute("multiple");var k=[],l=[],m=ia;return c.find("option").each(function(){var a=b(this),c=a.parent(),d=a.val(),e={id:d,text:a.text()};c.is("optgroup")&&(m=ha,e.group=c.attr("label")),k.push(e),a.is(":selected")&&l.push(d)}),m&&(e.group.valueField="group"),e.item.data=k,l.length&&(e.item.value=l),(g.hasAttribute("readonly")||c.is(":disabled"))&&(e.readonly=ha),c.hide(),c.after(d),d}function f(a){var c=a.option,d=a.context,e=c.result,f=ga(c.tabindex);if(f=c.tabindex=isNaN(f)||f<0?ia:f,f!==ia&&d.attr("tabindex",f),d.addClass(la),c.readonly&&d.addClass(qa),e.css&&d.addClass(e.css),e.style&&d.css(e.style),e.render&&e.render.call(d),c.mode===ab)return void(a.result=b());d.append(a.placeholder=jb(na).html(c.result.placeholder)),d.append(a.result=jb(oa));var g=e.arrow;g===ia||g===ja&&e.multi||(d.addClass(ma).append(jb(pa)),/static/i.test(X(d,"position"))&&d.css("position","relative"))}function g(a){var c=a.option,d=a.context,e=a.dom=jb(ra).addClass("{0}-mode-{0}".fill(ka,c.mode)),f=c.tabindex;switch(f!==ia&&e.attr("tabindex",f),c.mode){case ab:c.style.width=d.siblings(":visible").length?d.width():"auto",c.style.height=d.height()||"auto";var g=X(d,"position");c.style.position=/static/i.test(g)?"relative":g,d.append(e);break;case _a:b(da.body).append(e);break;case bb:b(da.body).append((a.mask=jb(sa)).append(e))}e.addClass(c.css).css(c.style).append(h(a,c));var i=c.box,k=a.box=jb(Ca).addClass("{0}-layout-{0}".fill(Ca,i.layout)).addClass(i.css).css(i.style);i.layout===db&&k.append(jb(ta)),e.append(k),e.append(j(a,c))}function h(a,b){var c=b.header,d=a.header=jb(wa).addClass(c.css).css(c.style).append(i(a,b));return c.render&&c.render.call(d,b.item.data),d}function i(c,d){var e=d.header.filter,f=b('<input type="text"  placeholder="{0}" class="{0}" maxlength="{0}" />'.fill(e.placeholder,Ka,e.maxlength)).addClass(e.css).css(e.style);return f.keyup(function(g){var h=f.val();aa&&(a.clearTimeout(aa),aa=0),(/^change$/i.test(e.trigger)?""===b.trim(String.fromCharCode(g.keyCode||g.which))||f.data("last")!==h:13===g.keyCode)&&(f.data("last",h),aa=fa(function(){d.ajax.url&&d.ajax.key?c.load():c.filter(h,ha)},e.delay))}),f}function j(a,b){var c=b.footer,d=a.footer=jb(xa).addClass(c.css).css(c.style),e=jb(ya),f=jb(za);return f.append(jb(Aa,Za).html(c.totalTpl.replace(Xa,0))),d.append(e).append(f),b.result.multi&&k(a,b,e,f),c.render&&c.render.call(d,b.data),d}function k(a,c,d,e){var f=b($a);d.append(b("<label>").append(f).append("全选")),f.change(function(){var c=f.is(":checked");P(a,Ya).each(function(d,e){if(e=b(e),c){if(e.hasClass(Ia))return;return void J(a,e,ha)}e.hasClass(Ia)&&K(a,e,ha)})});var g=jb(Ba,Za);R(c,g),e.prepend(g)}function l(a,c){var d=a.option.ajax,e=d.key,f=d.param||{},g=a.header.find("."+Ka).val();switch(d.encoder&&(g=d.encoder(g)),typeof f){case"string":e&&(f+="&{0}={0}".fill(e,g));break;case"function":f=f(g);break;case"object":e&&(f[e]=g);break;default:return void ea.error("Invalid ajax data format")}var h={url:d.url,type:d.type,data:f};d.req&&(h=d.req(h),ia===h)||b.ajax(h).done(function(a,b,e){d.res&&(a=d.res(a,b,e)),c(a)})}function m(a,b,c){var d=a.option.item;d.data=ib(b),o(a,function(){d.value&&a.value(d.value),v(a),c&&c.call(a,d.data)})}function n(a,c){var d=c.valueField,e=c.valueField,f=c.textField||e,g=[{isGroup:ha,text:c.unknown,id:0}],h={},i=0,j=[];if(b.each(a,function(a,b){var c={data:b,index:a,group:""};if(!d)return void j.push(c);var k=gb(b,e),l=gb(b,f);if(!k)return b.group=0,void g.push(c);var m=b[e],n=l?b[f]:"";gb(h,m)||(h[m]={id:++i,text:n,data:[]}),c.group=i,h[m].data.push(c)}),!d)return j;var k=[];return b.each(h,function(a,b){k.push({id:b.id,isGroup:ha,key:a,text:b.text}),kb(k,b.data)}),g.length>1&&kb(k,g),k}function o(a,b){var d=a.box,e=a.option,f=e.item,g=f.data,h=e.group,i=ga(f.visible);(isNaN(i)||i<0)&&(i=0);var j=g?g.length:0;d.height("auto"),e.box.layout===db?d.find(c.build(ta).first()).empty():d.empty(),a.fromSelect&&a.source.empty(),H(a),a.dom.removeClass(va);var k=N(a);if(U(k,j),Q(e,k),!j)return d.append(e.box.empty),a.dom.addClass(va),void(b&&b.call(a,g));g=n(g,h),j=g.length;var l=p(a,d,f,g,b,0,i);if(isNaN(ga(a.dom.get(0).style.height))){if(0===i||i>=j)return;$(a);var m=W(l).height;_(a);var o=0;if(h.valueField){var q=d.find(c.build(Da));o=q.first().height()*q.length}d.height(i*m+o)}else{var r=a.dom.height();if(a.header.is(Ya)&&(r-=W(a.header).height),a.footer.is(Ya)&&(r-=W(a.footer).height),d.height(r),0===i||i>=j)return}f.async?hb(p,[a,d,f,g,b,i]):p(a,d,f,g,b,0)}function p(a,b,d,e,f,g,h){var i,j=a.option.box.layout===db;j&&(b=b.find(c.build(ta).first()));var k=a.fromSelect,l=a.source,m=a.option.group,n=d.data;if(h=h||e.length-g,!(g>=e.length)){var o=g+h;o>e.length&&(o=e.length);for(var p,r=m.valueField,s=g;s<o;s++){var t=e[s];if(r&&t.isGroup){var u=jb(Da).addClass(m.css).css(m.style).html(t.text).attr(Wa,t.id);m.render&&u.append(m.render.call(a,u,t)),b.append(u),p=ja,k&&l.append(jb("","optgroup").text(t.text).attr("value",t.id))}else{var v=c.build(ua);p=b.find((r?v.attr(Wa,t.group):v).done()),p&&p.length||(p=jb(ua).attr(Wa,t.group),b.append(p));var w=t.index;t=t.data;var x=U(jb(Ea),t);if(p.append(x),x.addClass(d.css).css(d.style),j)q(a,t,x,w);else{var y=jb(Fa),z=jb(Ga),A=jb(Ha);x.append(y).append(z).append(A),z.append(d.render?d.render.call(x,t,w,n):t[d.textField])}x.attr(Va,s),r&&x.attr(Wa,t.group),i||(i=x),k&&l.append(jb("","option").text(t.text).attr("value",t.id))}}return o!==e.length?i:(f.call(a,n),i)}}function q(a,c,d,e){var f=a.option.box.columns;ba||(r(f),ba=ha),b.each(f,function(b,f){var g=jb(Oa),h=c[f.field];switch(h=void 0===h||null===h?"":h,f.type){case"index":h=e;break;case"status":g.addClass(Ha)}f.style&&g.css(f.style),f.css&&g.addClass(f.css),f.align&&g.css("text-align",f.align),f.width&&g.css("width",f.width),f.render&&(h=f.render.call(a,{rowIndex:e,columnIndex:b,data:c,value:h})),g.append(h),d.append(g)})}function r(a){if(a.every(function(a,b){return b.width})){var c=100/a.length;b.each(a,function(b){a[b].width="{0}%".fill(100*c)})}}function s(c){c.option.mode!==ab&&(t(c),w(c)),x(c),c.option.keyboard&&y(c),b(a).resize(function(){c.dom.is(Ya)&&(u(c.context,c.dom,c.option),v(c))})}function t(a){a.context.on("click focus",function(){a.option.readonly||a.dom.is(Ya)||a.show()})}function u(c,d,e){var f=c.offset(),g=e.mode,h=d.height(),i=b(a).height(),j=W(c),k=j.height,l=j.width;g===_a?(i-f.top-k<h?f.top=f.top-h-2:f.top=f.top+k,d.css({left:f.left,top:f.top,width:e.style.width||l})):g===bb&&d.parent().css({paddingTop:(i-h)/3,paddingLeft:(b(a).width()-d.width())/2})}function v(a){var b=a.dom;if("100%"!==b.get(0).style.height){var c=b.parent().height();if(c>0&&(a.option.mode===ab||b.height()>=c)){var d=Z(b);b.height(c-d.top-d.bottom)}}var e=b.get(0).style.height;e&&!/auto/i.test(e)&&a.box.height(b.height()-8-(a.header.is(Ya)?a.header.height():0)-(a.footer.is(Ya)?a.footer.height():0))}function w(c){var d=c.context,e=c.dom;b(a).mousedown(function(a){var b=a.target;d.is(b)||e.is(b)||d.find(b).length||e.find(b).length||e.is(Ya)&&c.hide()})}function x(a){a.box.on("click",c.build(Ea).done(),function(){var c=b(this);I(a,c,ha,ha),a.fromSelect&&a.option.result.sync&&a.source.val(a.value()),a.option.result.multi||a.hide()})}function y(d){b(a).keydown(function(a){if(d.dom.is(Ya)&&!b(a.target).hasClass(Ka)){var e,f=d.box.find(c.build(Ja).first());switch(a.keyCode||a.which){case 40:e=A(d,f);break;case 38:e=z(d,f);break;case 32:case 13:return void f.click();case 27:return void d.hide();default:return}e.length||(e=f),d.header.find("."+Ka).blur(),e.focus(),f.removeClass(Ja),e.addClass(Ja),B(e)}}),d.dom.on("mouseover",c.build(Ea).done(),function(){d.box.find("."+Ja).removeClass(Ja),b(this).addClass(Ja)})}function z(a,b){if(0===b.length)return P(a).eq(0);var d=b.prev();return d.length||(d=b.parent().prevAll(c.build(ua).first()).find(c.build(Ea).last())),d}function A(a,b){if(0===b.length)return P(a).eq(0);var d=b.next();return d.length||(d=b.parent().nextAll(c.build(ua).first()).find(c.build(Ea).first())),d}function B(a){var b=a.parent().parent();/auto/i.test(X(b,"overflowY"))||(b=b.parent()),b.stop().animate({scrollTop:a.offset().top-b.offset().top+b.scrollTop()-W(a).height},100)}function C(a,b,d){var e=a.option,f=e.result.item;if(e.mode!==ab){var g=jb(La).attr(Va,d).append(jb(Ma,Za).html(b)).append(jb(Na,Za).click(function(){if(!e.readonly)return K(a,P(a,c.build().attr(Va,d).first()),ha),ia}));return f.css&&g.addClass(f.css),f.style&&g.css(f.style),g}}function D(a,b,c){return E(a,b,{target:c.get(0),data:T(c),index:c.attr(Va)})}function E(a,b,c){if(gb(a.events,b)){c.type=b;for(var d=a.events[b],e=d.length-1;e>=0;e--)if(d[e].call(a,c)===ia)return ia}}function F(a){var d=a.option,e=d.item.valueField;if(!d.result.multi){var f=P(a,c.build(Ia).first());return 0===f.length?void 0:T(f)[e]}return b.makeArray(P(a,c.build(Ia).done()).map(function(a,c){return T(b(c))[e]}))}function G(a,c,d){for(var e,f=a.option,g=f.result.multi,h=b.makeArray(c),i=0,j=P(a);i<j.length;i++){e=b(j[i]);if(-1!==h.indexOf(T(e)[f.item.valueField])){if(I(a,e,ia,d),!g)return}else g&&K(a,e,d)}}function H(a){var d=P(a);if(a.result.empty(),a.option.result.multi)return void d.filter(c.build(Ia).done()).each(function(c,d){K(a,b(d),ha)});var e=d.filter(c.build(Ia).first());e.length&&K(a,e,ha)}function I(a,b,d,e){var f=a.option.result.multi,g=b.hasClass(Ia);if(!f){if(g)return;var h=a.box.find(c.build(Ia).done()).not(b).first();return h.length&&K(a,h,e),void J(a,b,e)}if(!g)return void J(a,b,e);d&&K(a,b,e)}function J(a,b,c){c&&D(a,Pa,b)===ia||(b.addClass(Ia),a.option.mode!==ab&&a.placeholder.hide(),L(a,T(b),b.attr(Va)))}function K(a,b,c){var d=a.option;c&&D(a,Qa,b)===ia||(b.removeClass(Ia),d.mode!==ab&&(d.result.multi?0===a.value().length:void 0===a.value())&&a.placeholder.show(),M(a,b.attr(Va)))}function L(a,b,c){var d=a.result,e=O(a),f=a.option,g=f.result,h=g.multi,i=g.item.render,j=b[f.item.textField];if(j=i?i.call(a,b):j,a.fromSelect&&a.source.val(a.value()),!h)return void d.text(j);if(f.mode!==ab){var k=C(a,j,c);d.append(k),d.stop().animate({scrollTop:d[0].scrollHeight})}U(e,(T(e)||0)+1),R(f,e)}function M(a,b){var d=a.option,e=d.result.multi;if(a.fromSelect&&a.source.val(a.value()),e){var f=O(a);a.result.find(c.build(La).attr(Va,b).first()).remove();var g=T(f);U(f,g>0?g-1:0),R(d,f)}}function N(a){return a.footer.find(c.build(za).sub(Aa).done())}function O(a){return a.footer.find(c.build(za).sub(Ba).done())}function P(a,b){return a.box.find(c.build(Ea).addon(b).done())}function Q(a,b){S(b,a.footer.totalTpl)}function R(a,b){S(b,a.footer.selectedTpl)}function S(a,b){a.html(b.replace(Xa,T(a)||0))}function T(a,b){return a.data(b||Sa)}function U(a,b,c){return a.data(c||Sa,b)}function V(a,b,d){var e=a.filter(c.build().attr(Wa,d).done());0===b.filter(c.build().attr(Wa,d).visible()).length?e.hide():e.show()}function W(a){var b=a.width(),c=a.height(),d=Y(a);return/^border-box$/i.test(X(a,"box-sizing"))&&(c+=d.top+d.bottom+ga(X(a,"border-top-width"))+ga(X(a,"border-bottom-width")),b+=d.left+d.right+ga(X(a,"border-left-width"))+ga(X(a,"border-right-width"))),{width:b,height:c}}function X(a,b){return a.css(b)}function Y(a){return{top:ga(X(a,"padding-top"))||0,right:ga(X(a,"padding-right"))||0,bottom:ga(X(a,"padding-bottom"))||0,left:ga(X(a,"padding-left"))||0}}function Z(a){return{top:ga(X(a,"border-top"))||0,right:ga(X(a,"border-right"))||0,bottom:ga(X(a,"border-bottom"))||0,left:ga(X(a,"border-left"))||0}}function $(a){U(a.dom,X(a.dom,Ta),Ta),a.dom.css({display:"block",visibility:"hidden"})}function _(a){a.dom.css({display:T(a.dom,Ta)||"none",visibility:Ua})}String.prototype.fill=function(){var a=[].slice.apply(arguments);return this.replace(/{([0-9]+)(\/.[lLrR]?)?}/g,function(b,c,d){var e=a.length?a.shift():"";if(e=null===e||void 0===e?"":String(e).toString(),0===c)return e;var f=c-e.length;if(f<=0)return e;for(var g=d[1],h=d[2]||"l",i="",j=0;j<f;j++)i+=g;return/r/i.test(h)?e+=i:e=i+e,e})};var aa,ba,ca=[],da=a.document,ea=a.console,fa=a.setTimeout,ga=a.parseInt,ha=!0,ia=!1,ja=null,ka="tinyselect",la=ka+"-context",ma=la+"-with-arrow",na=la+"-placeholder",oa=la+"-result",pa=la+"-arrow",qa=la+"-readonly",ra=ka+"-container",sa=ka+"-mask",ta=ka+"-scroll-proxy",ua=ka+"-group-content",va=ra+"-empty",wa=ka+"-header",xa=ka+"-footer",ya=xa+"-left",za=xa+"-right",Aa=ka+"-count-total",Ba=ka+"-count-selected",Ca=ka+"-box",Da=ka+"-group",Ea=ka+"-item",Fa=ka+"-item-before",Ga=ka+"-item-text",Ha=ka+"-item-after",Ia=Ea+"-selected",Ja=Ea+"-hover",Ka=ka+"-filter",La=ka+"-result-item",Ma=La+"-text",Na=La+"-link",Oa=Ea+"-table-col",Pa="select",Qa="unselect",Ra=[Pa,Qa],Sa="data",Ta="display",Ua="visible",Va="data-index",Wa="data-group",Xa="%s",Ya=":"+Ua,Za="span",$a='<input type="checkbox" style="vertical-align:-2px;" class="{0}-selectall" />'.fill(ka),_a="dropdown",ab="list",bb="popup",cb=[_a,ab,bb],db="table",eb=["list","grid",db],fb={ready:ja,readonly:ia,mode:_a,keyboard:ha,tabindex:0,css:ja,style:{lineHeight:"28px"},ajax:{url:ja,type:"get",param:ja,key:ja,encoder:ja,req:ja,res:ja,auto:ha},header:{render:ia,filter:{trigger:"enter",delay:618,placeholder:"输入后按回车过滤",matchCase:ia,maxlength:32,css:ja,style:{}},css:ja,style:{}},box:{empty:"没有数据",layout:"list",css:ja,style:{},columns:ja},group:{valueField:ia,textField:ia,unknown:"未分组",render:ia,css:ja,style:{}},item:{data:[],value:ia,valueField:"id",textField:"text",visible:5,render:ia,async:ha,css:ja,style:{}},footer:{render:ia,totalTpl:"共{0}项".fill(Xa),selectedTpl:"选中{0}项/".fill(Xa),css:ja,style:{}},result:{placeholder:"请选择",clear:ha,multi:ia,arrow:ja,sync:ha,render:ia,type:0,css:null,style:{},item:{render:ia,style:ja,css:ja}}};c.prototype={constructor:c,css:function(a){return a&&this.selector.push("."+a),this},attr:function(a,b){return 1===arguments.length?this.selector.push("[{0}]".fill(a)):this.selector.push("[{0}={0}]".fill(a,b)),this},sub:function(a){return this.selector.push(" "),this.css(a)},visible:function(){return this.addon(Ya).done()},first:function(){return this.addon(":first").done()},last:function(){return this.addon(":last").done()},addon:function(a){return a&&this.selector.push(a),this},done:function(a){return this.css(a),this.selector.join("")}},c.build=function(a){return new c(a)};var gb=function(a,b){return!a||a.hasOwnProperty(b)},hb=function(a,b){fa(function(){a.apply(ja,b)},0)},ib=function(a,c){return b.extend(ha,b.isArray(a)?[]:{},a,c)},jb=function(a,c){return b('<{0} class="{0}">'.fill(c||"div",a))},kb=function(a,b){Array.prototype.push.apply(a,b)};d.fn=d.prototype={constructor:d,init:function(a,c,d){var h=this;if(h.ready=ia,b.isArray(c))h.option=ib(fb,{item:{data:c},result:{multi:d}});else{h.option=ib(fb,c);var i=h.option.mode||_a;if(-1===cb.indexOf(i))throw new Error('Render mode "{0}" is not supported,\nhere is the valid modes: {0}'.fill(i,cb.join()));var j=h.option.box.layout||"list";if(-1===eb.indexOf(j))throw new Error('Layout "{0}" is not supported,\nhere is the valid modes: {0}'.fill(j,eb.join()));if(j===db&&!h.option.box.columns)throw new Error('You specified table-layout, but you have not set option "box.columns"')}return c=h.option,h.source=a=b(a),h.context=a.is("select")?e(h,a):a,f(h),h.events={},g(h),s(h),c.ajax.url&&!c.ajax.auto||h.load(c.item.data,function(){h.ready=ha,c.ready&&c.ready.call(h)}),h},on:function(a,b){var c=this;if(-1===Ra.indexOf(a))return ea.warn("{0}:{0}".fill("不支持此事件类型",a)),c;var d=c.events;return gb(d,a)?d[a].push(b):d[a]=[b],c},off:function(a,b){var c=this;if(-1===Ra.indexOf(a))return c;var d=c.events;if(!gb(d,a))return c;var e=d[a],f=e.indexOf(b);return-1!==f&&e.splice(f,1),c},show:function(a){var b=this,d=b.dom,e=b.option.mode;return e===ab?b:(e===bb&&b.mask.show(),u(b.context,d,b.option),d.fadeIn("fast",function(){d.find(c.build(wa).sub(Ka).visible()).focus(),v(b),a&&a.call(b)}),b)},hide:function(a){var b=this,c=b.option.mode;return c===ab?b:((c===_a?b.dom:b.mask).fadeOut("fast",function(){a&&a.call(b)}),b)},filter:function(a,d){function e(a){if(i){var c=b(a).attr(Wa),d=l[c];++d.handled<d.total||V(k,j,c)}}var f=this,g=[],h=b.isFunction(a),i=f.option.group.valueField,j=P(f),k=f.dom.find(c.build(Da).done()),l={};return k.each(function(){var a=b(this).attr(Wa);l[a]={total:j.filter(c.build(Ea).attr(Wa,a).done()).length,handled:0}}),j.each(function(c,i){i=b(i);var j=T(i);(h?a.call(this,j):f.option.header.filter.matchCase?-1!==i.text().indexOf(a.toString()):-1!==i.text().toLowerCase().indexOf(a.toString().toLowerCase()))?(g.push({item:i,data:j}),d&&i.slideDown(50,function(){e(this)})):d&&i.slideUp(50,function(){e(this)})}),g},value:function(a,b){var c=this;return 0===arguments.length?F(c):(G(c,a,b),c)},clear:function(){return H(this),this},load:function(a,c){var d=this;return d.option.ajax.url?(b.isFunction(a)&&(c=a),l(d,function(a){m(d,a,c)}),d):(m(d,a,c),d)},readonly:function(a){var b=this;return 0===arguments.length?b.option.readonly:(a?(b.hide(),b.context.addClass(qa)):b.context.removeClass(qa),b.option.readonly=a,b)}},d.fn.init.prototype=d.fn,d.defaults=fb,a.tinyselect=d}(window,jQuery);